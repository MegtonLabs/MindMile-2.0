<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindMile Dashboard</title> <!-- Updated Title -->
    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        /* --- Base & Global --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        /* Added smooth scroll */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fe;
            color: #34495e;
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        ul {
            list-style: none;
        }

        button,
        input,
        select,
        textarea {
            font-family: inherit;
            font-size: inherit;
            border-radius: 8px;
            border: 1px solid #dfe4ea;
            /* Default border */
        }

        button {
            cursor: pointer;
            background-color: transparent;
            padding: 8px 15px;
            border: none;
            /* Remove border for buttons unless specific class adds it */
        }

        textarea {
            resize: vertical;
        }

        input[type="text"],
        input[type="number"],
        input[type="datetime-local"],
        input[type="email"],
        input[type="password"],
        select,
        textarea {
            /* Added input types */
            width: 100%;
            padding: 10px 14px;
            background-color: #f8f9fa;
            color: #34495e;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input::placeholder,
        textarea::placeholder {
            color: #a0aec0;
        }

        input:focus,
        textarea:focus,
        select:focus,
        input[type="datetime-local"]:focus {
            /* Added datetime-local */
            outline: none;
            border-color: #5D5FEF;
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(93, 95, 239, 0.15);
        }

        /* Helper class for small text below inputs */
        .form-text-helper {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 4px;
            display: block;
        }


        /* --- Layout --- */
        .dashboard-container {
            display: flex;
            width: 100%;
        }

        .sidebar {
            width: 260px;
            background-color: #ffffff;
            padding: 25px 15px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e7eaf3;
            flex-shrink: 0;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            transition: width 0.3s ease, transform 0.3s ease, padding 0.3s ease;
            overflow-y: auto;
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.05);
        }

        .main-content {
            flex-grow: 1;
            padding: 30px 40px;
            background-color: #f8f9fe;
            margin-left: 260px;
            transition: margin-left 0.3s ease;
            width: calc(100% - 260px);
            min-height: 100vh;
        }

        /* --- Sidebar --- */
        .sidebar-header {
            display: flex;
            align-items: center;
            margin-bottom: 35px;
            padding-left: 10px;
            flex-shrink: 0;
        }

        .sidebar-logo {
            background-color: #5D5FEF;
            color: white;
            font-weight: bold;
            padding: 9px 13px;
            border-radius: 10px;
            margin-right: 12px;
            font-size: 1.25em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: margin 0.3s ease;
        }

        .sidebar-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #5D5FEF;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        .sidebar-menu {
            flex-grow: 1;
        }

        .sidebar-menu .menu-heading {
            display: block;
            font-size: 0.75em;
            color: #95a5a6;
            text-transform: uppercase;
            margin-top: 30px;
            margin-bottom: 12px;
            padding-left: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        .sidebar-menu ul li a {
            display: flex;
            align-items: center;
            padding: 13px 18px;
            border-radius: 8px;
            margin-bottom: 6px;
            color: #5f6774;
            font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease, padding 0.3s ease;
            font-size: 0.95em;
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar-menu ul li a i {
            margin-right: 16px;
            width: 20px;
            text-align: center;
            color: #8a94a6;
            font-size: 1.1em;
            transition: color 0.2s ease, margin 0.3s ease;
            flex-shrink: 0;
        }

        .sidebar-menu ul li a span {
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        .sidebar-menu ul li a:hover,
        .sidebar-menu ul li a.active {
            background-color: #F4F4FF;
            color: #5D5FEF;
        }

        .sidebar-menu ul li a:hover i,
        .sidebar-menu ul li a.active i {
            color: #5D5FEF;
        }

        .sidebar-menu ul li a.active {
            font-weight: 600;
        }

        /* --- Main Header --- */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .main-header .greeting {
            flex-shrink: 0;
        }

        /* Prevent greeting from shrinking too much initially */
        .main-header .greeting h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #2c3e50;
            line-height: 1.3;
        }

        .main-header .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            /* Reduced gap slightly */
            flex-wrap: wrap;
            justify-content: flex-end;
            flex-grow: 1;
        }

        .create-test-btn {
            background-color: #5D5FEF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(93, 95, 239, 0.2);
            white-space: nowrap;
        }

        .create-test-btn i {
            font-size: 0.9em;
        }

        .create-test-btn:hover {
            background-color: #4a4cc7;
            box-shadow: 0 6px 12px rgba(93, 95, 239, 0.3);
        }

        .search-bar {
            position: relative;
            flex-basis: 250px;
            /* Base width */
            flex-grow: 1;
            max-width: 400px;
        }

        /* Allow growth but limit max width */
        .search-bar input {
            padding: 10px 15px 10px 40px;
            border-radius: 8px;
            border: 1px solid #dfe4ea;
            width: 100%;
            font-size: 0.9rem;
            background-color: #fff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .search-bar i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #adb5bd;
            font-size: 0.9em;
            pointer-events: none;
        }

        /* Prevent icon click */
        .profile-container {
            position: relative;
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #e7eaf3;
            transition: border-color 0.2s ease;
            display: block;
        }

        .profile-container:hover .user-avatar img {
            border-color: #5D5FEF;
        }

        .profile-dropdown {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.12);
            padding: 8px 0;
            width: 190px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(8px);
            transition: opacity 0.25s ease, visibility 0.25s ease, transform 0.25s ease;
        }

        .profile-container:hover .profile-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-dropdown::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 15px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid #ffffff;
            filter: drop-shadow(0 -2px 2px rgba(0, 0, 0, 0.03));
        }

        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 10px 18px;
            font-size: 0.9rem;
            color: #495057;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .profile-dropdown ul li a i {
            margin-right: 12px;
            width: 18px;
            text-align: center;
            color: #8a94a6;
            font-size: 1rem;
            transition: color 0.2s ease;
        }

        .profile-dropdown ul li a:hover {
            background-color: #F4F4FF;
            color: #5D5FEF;
        }

        .profile-dropdown ul li a:hover i {
            color: #5D5FEF;
        }

        /* --- Stats Grid --- */
        /* Using auto-fit for inherent responsiveness */
        .stats-grid {
            display: grid;
            /* Adjust minmax values: min width a card should have, 1fr allows it to grow */
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            /* Default gap */
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            /* Vertically align icon and text */
            gap: 15px;
            border: 1px solid #e7eaf3;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        }

        .stat-card .icon-container {
            padding: 14px;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            flex-shrink: 0;
        }

        /* Icon colors (keep existing) */
        .stat-card:nth-child(1) .icon-container {
            background-color: #e9f3fe;
            color: #3a86ff;
        }

        .stat-card:nth-child(2) .icon-container {
            background-color: #E8F5E9;
            color: #388E3C;
        }

        /* Tests Created */
        .stat-card:nth-child(3) .icon-container {
            background-color: #FFF8E1;
            color: #FFB300;
        }

        /* Accuracy */
        .stat-card:nth-child(4) .icon-container {
            background-color: #F3E5F5;
            color: #8E24AA;
        }

        /* Participants */
        .stat-card:nth-child(5) .icon-container {
            background-color: #E0F2F7;
            color: #0288D1;
        }

        /* Rank */
        .stat-card:nth-child(6) .icon-container {
            background-color: #FDECEA;
            color: #E53935;
        }

        /* Points */
        .stat-card .stat-info {
            flex-grow: 1;
            min-width: 0;
        }

        /* Allow text to shrink */
        .stat-card .stat-title {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            line-height: 1.4;
        }

        .stat-card .stat-value {
            font-size: 1.7em;
            font-weight: 600;
            color: #34495e;
            display: block;
            line-height: 1.3;
            word-break: break-all;
        }

        /* --- Chart --- */
        .chart-container {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #e7eaf3;
            min-height: 400px;
            /* Adjust this value as needed */
            display: flex;
            /* Allow canvas to grow */
            flex-direction: column;
            /* Stack title/canvas vertically if needed */
        }

        .chart-container canvas {
            flex-grow: 1;
            /* Allow canvas to take available space */
            max-height: 500px;
            /* Optional: Prevent excessive height */
        }

        /* --- General Modal Styles --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(34, 47, 62, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding: 20px;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 850px;
            /* Adjusted width */
            position: relative;
            transform: translateY(-20px) scale(0.98);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* Prevent content overflow */
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e7eaf3;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #95a5a6;
            line-height: 1;
            padding: 5px;
            transition: color 0.2s ease;
        }

        .modal-close-btn:hover {
            color: #5f6774;
        }

        .modal-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 30px;
            background-color: #f8f9fe;
            /* Light background for body */
        }

        .modal-footer {
            padding: 15px 30px;
            border-top: 1px solid #e7eaf3;
            background-color: #fff;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        /* --- Create Test Modal Specific Styles --- */
        #createTestModal .form-section {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e7eaf3;
        }

        #createTestModal .form-group {
            margin-bottom: 20px;
        }

        #createTestModal .form-group:last-child {
            margin-bottom: 0;
        }

        #createTestModal label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
        }

        /* Visibility Radios */
        .visibility-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .visibility-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 400;
            font-size: 0.95rem;
            cursor: pointer;
            margin-bottom: 0;
        }

        .visibility-options input[type="radio"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #adb5bd;
            border-radius: 50%;
            transition: border-color 0.2s ease, background-color 0.2s ease;
            cursor: pointer;
            position: relative;
            top: -1px;
            flex-shrink: 0;
        }

        .visibility-options input[type="radio"]:checked {
            border-color: #5D5FEF;
            background-color: #5D5FEF;
        }

        .visibility-options input[type="radio"]:checked::after {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Keywords */
        .keywords-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            border: 1px solid #dfe4ea;
            border-radius: 8px;
            background-color: #f8f9fa;
            min-height: 40px;
            align-items: center;
        }

        .keyword-tag {
            background-color: #e9ecef;
            color: #495057;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            line-height: 1.4;
            border: none;
        }

        .keyword-tag .remove-keyword {
            background: none;
            border: none;
            color: #6c757d;
            font-size: 1.1em;
            line-height: 1;
            padding: 0 2px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .keyword-tag .remove-keyword:hover {
            color: #e53935;
        }

        #keywordInput {
            border: none !important;
            background: none !important;
            padding: 0 !important;
            margin: 0 !important;
            flex-grow: 1;
            font-size: 0.95rem;
            outline: none !important;
            box-shadow: none !important;
            min-width: 150px;
        }

        /* Questions List */
        #questions-list {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .question-card {
            background-color: #fff;
            border: 1px solid #e7eaf3;
            border-radius: 10px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: box-shadow 0.2s ease;
        }

        .question-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .question-card-content {
            flex-grow: 1;
            padding-right: 15px;
            font-size: 0.95rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .question-card-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .question-card-actions .btn-icon {
            background: none;
            border: none;
            padding: 5px;
            font-size: 1.1em;
            line-height: 1;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .question-card-actions .edit-q-btn {
            color: #5D5FEF;
        }

        .question-card-actions .edit-q-btn:hover {
            background-color: #f4f4ff;
        }

        .question-card-actions .delete-q-btn {
            color: #e53935;
        }

        .question-card-actions .delete-q-btn:hover {
            background-color: #fdecea;
        }

        /* Question Editor */
        #question-editor {
            background-color: #f0f2f5;
            border: 1px dashed #ced4da;
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            position: relative;
            transition: background-color 0.3s ease;
        }

        #question-editor.editing {
            background-color: #e9f3fe;
            border-style: solid;
            border-color: #5D5FEF;
        }

        #question-editor h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #34495e;
            margin-top: 0;
            margin-bottom: 20px;
        }

        #options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            accent-color: #5D5FEF;
            cursor: pointer;
        }

        .option-item input[type="text"] {
            flex-grow: 1;
            padding: 8px 12px;
            font-size: 0.9rem;
            background-color: #fff;
        }

        /* White background for options */
        .option-item .remove-option-btn {
            background: none;
            border: none;
            color: #adb5bd;
            font-size: 1.2em;
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 0 5px;
            line-height: 1;
            flex-shrink: 0;
        }

        .option-item .remove-option-btn:hover {
            color: #e53935;
        }

        .question-editor-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* General Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            border-radius: 8px;
            padding: 9px 18px;
            transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            border: 1px solid transparent;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn i {
            font-size: 0.95em;
            line-height: 1;
        }

        .btn-primary {
            background-color: #5D5FEF;
            color: white;
            border-color: #5D5FEF;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #4a4cc7;
            border-color: #4a4cc7;
            box-shadow: 0 4px 10px rgba(93, 95, 239, 0.2);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #5a6268;
            border-color: #5a6268;
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
            border-color: #2ecc71;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #27ae60;
            border-color: #27ae60;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.2);
        }

        .btn-outline-secondary {
            background-color: transparent;
            color: #6c757d;
            border-color: #ced4da;
        }

        .btn-outline-secondary:hover:not(:disabled) {
            background-color: #f8f9fa;
            color: #5a6268;
            border-color: #adb5bd;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #c0392b;
            border-color: #c0392b;
        }

        .btn:disabled {
            background-color: #e9ecef;
            border-color: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn:disabled:hover {
            transform: none;
        }

        #addOptionBtn {
            margin-top: 10px;
            align-self: flex-start;
        }

        /* Position Add Option button */

        /* Time Limit Input Group */
        .time-limit-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-limit-group input[type="number"] {
            flex-grow: 1;
            /* Allow number input to take most space */
            width: auto;
            /* Override default 100% width */
        }

        .time-limit-group select {
            flex-shrink: 0;
            /* Prevent dropdown from shrinking */
            width: auto;
            /* Adjust width based on content */
            padding-right: 35px;
            /* Ensure space for dropdown arrow */
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23a0aec0'%3E%3Cpath d='M7 10l5 5 5-5H7z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 1em;
        }

        /* Share Link Section */
        #share-link-section {
            margin-top: 20px;
            padding: 25px;
            background-color: #e8f5e9;
            border-radius: 12px;
            border: 1px solid #a5d6a7;
            text-align: center;
            display: none;
            /* Hidden by default */
        }

        #share-link-section h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #388e3c;
        }

        #share-link-section p {
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        #share-link-section .share-link-input-group {
            display: flex;
            gap: 0;
            /* Remove gap for attached button */
        }

        #shareLinkInput {
            flex-grow: 1;
            padding: 10px 14px;
            border: 1px solid #ced4da;
            border-right: none;
            /* Remove right border */
            border-radius: 8px 0 0 8px;
            background-color: #fff;
            color: #495057;
            font-size: 0.9rem;
        }

        #copyLinkBtn {
            border-radius: 0 8px 8px 0;
        }

        /* Adjust button radius */

        /* --- Test Preview Modal Styles --- */
        #testPreviewModal .modal-body {
            background-color: #fff;
        }

        /* White background for preview */
        #testPreviewModal .preview-question-item {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        #testPreviewModal .preview-question-text {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1.05rem;
        }

        #testPreviewModal .preview-options-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            list-style: none;
            padding-left: 0;
        }

        #testPreviewModal .preview-option label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            border: 1px solid #dfe4ea;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        #testPreviewModal .preview-option input[type="radio"],
        #testPreviewModal .preview-option input[type="checkbox"] {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            accent-color: #5D5FEF;
        }

        #testPreviewModal .preview-option label:hover {
            background-color: #f8f9fa;
            border-color: #adb5bd;
        }

        #testPreviewModal .modal-footer {
            justify-content: center;
        }

        /* Center footer button */

        /* --- Responsive Design --- */

        /* Medium devices (tablets, 768px and up) */
        @media (min-width: 768px) {
            .main-header {
                flex-wrap: nowrap;
                align-items: center;
            }

            .main-header .greeting h1 {
                font-size: 2rem;
            }

            .main-header .header-actions {
                flex-grow: 0;
                /* Don't allow actions to grow */
                gap: 20px;
            }

            .search-bar {
                flex-basis: 300px;
                /* Slightly larger base */
            }

            .stats-grid {
                gap: 25px;
            }

            /* Increase gap */
            .stat-card .stat-value {
                font-size: 1.9em;
            }

            .main-content {
                padding: 30px;
            }

            .chart-container {
                padding: 25px;
            }

            .modal-header h2 {
                font-size: 1.6rem;
            }
        }

        /* Large devices (desktops, 992px and up) */
        @media (min-width: 992px) {
            .main-header .greeting h1 {
                font-size: 2.2rem;
            }

            .stat-card .stat-value {
                font-size: 2em;
            }

            .sidebar {
                width: 260px;
            }

            /* Expanded sidebar */
            .main-content {
                margin-left: 260px;
                width: calc(100% - 260px);
            }

            .sidebar-title,
            .sidebar-menu .menu-heading,
            .sidebar-menu ul li a span {
                opacity: 1;
                pointer-events: auto;
                width: auto;
            }

            .sidebar-header {
                justify-content: flex-start;
                padding-left: 10px;
            }

            .sidebar-logo {
                margin-right: 12px;
            }

            .sidebar-menu ul li a {
                justify-content: flex-start;
                padding: 13px 18px;
            }

            .sidebar-menu ul li a i {
                margin-right: 16px;
                font-size: 1.1em;
            }
        }

        /* Extra large devices (large desktops, 1200px and up) */
        @media (min-width: 1200px) {
            .stats-grid {
                gap: 30px;
            }

            /* Even larger gap */
            .main-content {
                padding: 35px 50px;
            }

            .search-bar {
                flex-basis: 350px;
            }
        }

        /* Styles for collapsed sidebar state (applied below 992px) */
        @media (max-width: 991.98px) {
            .sidebar {
                width: 80px;
                padding: 25px 10px;
            }

            .main-content {
                margin-left: 80px;
                width: calc(100% - 80px);
            }

            .sidebar-title,
            .sidebar-menu .menu-heading,
            .sidebar-menu ul li a span {
                opacity: 0;
                pointer-events: none;
                width: 0;
            }

            .sidebar-header {
                justify-content: center;
                padding-left: 0;
            }

            .sidebar-logo {
                margin-right: 0;
            }

            .sidebar-menu ul li a {
                justify-content: center;
                padding: 15px 10px;
            }

            .sidebar-menu ul li a i {
                margin-right: 0;
                font-size: 1.3em;
            }
        }

        /* Smaller Tablets / Large Phones */
        @media (max-width: 767.98px) {
            .main-content {
                padding: 25px 20px;
            }

            .stats-grid {
                gap: 15px;
            }

            .stat-card {
                padding: 15px;
                gap: 12px;
                align-items: flex-start;
            }

            .stat-card .icon-container {
                font-size: 1.4em;
                padding: 12px;
                margin-top: 3px;
            }

            .stat-card .stat-title {
                font-size: 0.8rem;
            }

            .stat-card .stat-value {
                font-size: 1.5em;
            }

            .modal-body {
                padding: 20px;
            }

            .modal-header,
            .modal-footer {
                padding: 15px 20px;
            }

            .question-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .question-card-actions {
                align-self: flex-end;
            }

            .time-limit-group {
                flex-wrap: wrap;
            }

            /* Allow unit dropdown to wrap */
        }

        /* Mobile devices (576px and down) */
        @media (max-width: 575.98px) {
            .sidebar {
                transform: translateX(-100%);
                width: 0;
                padding: 0;
                border: none;
                box-shadow: none;
                position: absolute;
                /* Needs JS to toggle */
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 20px 15px;
            }

            .main-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            /* Stack header items */
            .main-header .greeting {
                text-align: center;
            }

            .main-header .header-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .create-test-btn {
                justify-content: center;
            }

            .search-bar {
                max-width: none;
                flex-basis: auto;
            }

            .profile-container {
                align-self: center;
            }

            .profile-dropdown {
                right: auto;
                left: 50%;
                transform: translateX(-50%) translateY(8px);
            }

            .profile-container:hover .profile-dropdown {
                transform: translateX(-50%) translateY(0);
            }

            .profile-dropdown::before {
                right: auto;
                left: 50%;
                transform: translateX(-50%);
            }

            .stats-grid {
                grid-template-columns: 1fr;
                /* Force single column */
                gap: 12px;
            }

            .stat-card {
                padding: 12px 15px;
                gap: 10px;
            }

            .stat-card .icon-container {
                font-size: 1.3em;
                padding: 10px;
            }

            .stat-card .stat-title {
                white-space: normal;
                overflow: visible;
                text-overflow: clip;
            }

            /* Allow title wrap */
            .stat-card .stat-value {
                font-size: 1.3em;
            }

            .chart-container {
                padding: 15px;
                min-height: 300px;
                /* Adjust height for mobile */
            }

            .modal-content {
                max-height: calc(100vh - 20px);
            }

            .modal-body {
                padding: 15px;
            }

            .modal-header,
            .modal-footer {
                padding: 15px;
            }

            .btn {
                font-size: 0.85rem;
                padding: 8px 14px;
            }

            .modal-header h2 {
                font-size: 1.2rem;
            }

            #share-link-section .share-link-input-group {
                flex-direction: column;
                gap: 5px;
            }

            /* Stack copy elements */
            #shareLinkInput {
                border-radius: 8px;
                border-right: 1px solid #ced4da;
            }

            #copyLinkBtn {
                border-radius: 8px;
            }
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-logo">M</span> <!-- Changed Logo -->
            <span class="sidebar-title">MindMile</span> <!-- Changed Title -->
        </div>
        <div class="sidebar-menu">
            <span class="menu-heading">ACCOUNT</span>
            <ul>
                <li><a href="#" class="active"><i class="fas fa-home-alt"></i> <span>Dashboard</span></a></li>
                <li><a href="#"><i class="fas fa-pencil-alt"></i> <span>Test</span></a></li>

                <li><a href="#"><i class="fas fa-trophy"></i> <span>Leaderboard</span></a></li>
            </ul>
            <span class="menu-heading">SUPPORT</span>
            <ul>
                <li><a href="#"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
                <li><a href="#"><i class="fa-solid fa-address-book"></i> <span>Contact Us</span></a></li>
            </ul>
        </div>
    </nav>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Main Content -->
        <main class="main-content">
            <!-- Main Header -->
            <header class="main-header">
                <div class="greeting">
                    <h1>Hi, User</h1> <!-- Replace with dynamic username -->
                </div>
                <div class="header-actions">
                    <button class="create-test-btn" id="createTestBtnTrigger">
                        <i class="fas fa-plus"></i> Create Test
                    </button>
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search tests or topics...">
                    </div>
                    <div class="profile-container">
                        <div class="user-avatar">
                            <!-- Replace with dynamic avatar -->
                            <img src="https://cdn-icons-png.flaticon.com/512/147/147144.png" alt="User Avatar">
                        </div>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="#" class="dropdown-item"><i class="fas fa-user-circle"></i>
                                        <span>Profile</span></a></li>
                                <li><a href="#" class="dropdown-item"><i class="fas fa-cog"></i>
                                        <span>Settings</span></a></li>
                                <!-- Example: Add Dark Mode Toggle Here if desired -->
                                <!-- <li><a href="#" class="dropdown-item"><i class="fas fa-moon"></i> <span>Dark Mode</span></a></li> -->
                                <li><a href="#" class="dropdown-item"><i class="fas fa-sign-out-alt"></i> <span>Log
                                            out</span></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Stats Grid -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="icon-container"><i class="far fa-calendar-check"></i></div>
                    <!-- Replace numbers dynamically -->
                    <div class="stat-info"><span class="stat-title">Attempted Tests</span><span
                            class="stat-value">20</span></div>
                </div>
                <div class="stat-card">
                    <div class="icon-container"><i class="fas fa-pencil-alt"></i></div>
                    <div class="stat-info"><span class="stat-title">Tests Created</span><span
                            class="stat-value">5</span></div>
                </div>
                <div class="stat-card">
                    <div class="icon-container"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-info"><span class="stat-title">Overall Accuracy</span><span
                            class="stat-value">78%</span></div>
                </div>
                <div class="stat-card">
                    <div class="icon-container"><i class="fas fa-users"></i></div>
                    <div class="stat-info"><span class="stat-title">Total Participants (My Tests)</span><span
                            class="stat-value">152</span></div>
                </div>
                <div class="stat-card">
                    <div class="icon-container"><i class="fas fa-trophy"></i></div>
                    <div class="stat-info"><span class="stat-title">Leaderboard Rank</span><span
                            class="stat-value">#12</span></div>
                </div>
                <div class="stat-card">
                    <div class="icon-container"><i class="fas fa-bullseye"></i></div>
                    <div class="stat-info"><span class="stat-title">Points Earned</span><span
                            class="stat-value">1250</span></div>
                </div>
            </section>

            <!-- Chart Container -->
            <section class="chart-container">
                <!-- Canvas for Chart.js -->
                <canvas id="accuracyChart"></canvas>
            </section>
        </main>
    </div>


    <!-- Create Test Modal -->
    <div class="modal-overlay" id="createTestModalOverlay">
        <div class="modal-content" id="createTestModal">
            <div class="modal-header">
                <h2>Create a New Test</h2>
                <button class="modal-close-btn" id="modalCloseBtn">×</button>
            </div>
            <div class="modal-body">
                <!-- Test Details Section -->
                <div class="form-section" id="test-details-section">
                    <form action="#" id="createTestForm">
                        <div class="form-group">
                            <label for="testName">Test Label</label>
                            <input type="text" id="testName" name="testName" placeholder="E.g., 'Advanced JS Quiz V1'"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="testDescription">Description (Public)</label>
                            <textarea id="testDescription" name="testDescription"
                                placeholder="Enter a brief description visible to participants"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Visibility</label>
                            <div class="visibility-options">
                                <label><input type="radio" name="visibility" value="public" checked> Public</label>
                                <label><input type="radio" name="visibility" value="unlisted"> Private</label>
                                <!-- Changed label -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="testStartTime">Start Time</label>
                            <input type="datetime-local" id="testStartTime" name="testStartTime">
                            <small class="form-text-helper">Participants can only join after this time.</small>
                        </div>
                        <div class="form-group">
                            <label for="testEndTime">End Time</label>
                            <input type="datetime-local" id="testEndTime" name="testEndTime">
                            <small class="form-text-helper">Participants cannot join or submit after this time.</small>
                        </div>
                        <!-- Updated Time Limit Group -->
                        <div class="form-group">
                            <label for="testTimeLimitValue">Time Limit</label>
                            <div class="time-limit-group">
                                <input type="number" id="testTimeLimitValue" name="testTimeLimitValue"
                                    placeholder="Optional" min="1">
                                <select id="testTimeLimitUnit" name="testTimeLimitUnit">
                                    <option value="minutes" selected>Minutes</option>
                                    <option value="hours">Hours</option>
                                </select>
                            </div>
                            <small class="form-text-helper">Duration once started. Applies if no fixed End Time is set,
                                or limits duration within Start/End window.</small>
                        </div>
                        <div class="form-group">
                            <label for="testExpiryDate">Expiry Date (Optional)</label>
                            <input type="datetime-local" id="testExpiryDate" name="testExpiryDate">
                            <small class="form-text-helper">Alternative to End Time; test becomes unavailable after
                                this.</small>
                        </div>
                        <div class="form-group">
                            <label for="keywordInput">Keywords (Topics)</label>
                            <div class="keywords-input-container">
                                <div id="keywordsDisplay" style="display: contents;"></div>
                                <!-- Use display: contents -->
                                <input type="text" id="keywordInput" placeholder="Add keywords & press Enter">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Questions Section -->
                <div class="form-section" id="questions-section">
                    <h3 style="margin-bottom: 15px; font-weight: 600;">Questions (<span id="questions-count">0</span>)
                    </h3>
                    <div id="questions-list">
                        <!-- Question cards will be rendered here -->
                        <p id="no-questions-msg" style="color: #6c757d; text-align: center; padding: 15px 0;">No
                            questions added yet. Click "Add Question" below.</p>
                    </div>
                </div>

                <!-- Question Editor (Appears when adding/editing) -->
                <div id="question-editor" class="form-section" style="display: none;">
                    <h3>Question <span id="editingQuestionNumber">1</span></h3>
                    <div class="form-group">
                        <label for="questionText">Question Text</label>
                        <textarea id="questionText" placeholder="Enter the question" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Options (Mark correct answer(s))</label>
                        <div id="options-container">
                            <!-- Option items will be added here -->
                        </div>
                        <button type="button" id="addOptionBtn" class="btn btn-outline-secondary btn-sm mt-2"><i
                                class="fas fa-plus"></i> Add Option</button>
                    </div>
                    <div class="question-editor-actions">
                        <button type="button" id="cancelEditBtn" class="btn btn-outline-secondary">Cancel</button>
                        <button type="button" id="saveQuestionBtn" class="btn btn-primary" disabled><i
                                class="fas fa-save"></i> Save Question</button>
                    </div>
                </div>

                <!-- Share Link Section (Initially Hidden) -->
                <div id="share-link-section" class="form-section">
                    <h3><i class="fas fa-check-circle"></i> Test Published Successfully!</h3>
                    <p>Share this link with participants:</p>
                    <div class="share-link-input-group">
                        <input type="text" id="shareLinkInput" readonly>
                        <button type="button" id="copyLinkBtn" class="btn btn-primary"><i class="fas fa-copy"></i>
                            Copy</button>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" id="addQuestionBtn" class="btn btn-secondary"><i class="fas fa-plus"></i> Add
                    Question</button>
                <button type="button" id="previewTestBtn" class="btn btn-outline-secondary" disabled><i
                        class="fas fa-eye"></i> Preview Test</button>
                <button type="button" id="publishTestBtn" class="btn btn-success" disabled><i
                        class="fas fa-paper-plane"></i> Publish Test</button>
            </div>
        </div>
    </div>

    <!-- Test Preview Modal -->
    <div class="modal-overlay" id="testPreviewModalOverlay">
        <div class="modal-content" id="testPreviewModal">
            <div class="modal-header">
                <h2 id="previewModalTitle">Test Preview</h2>
                <button class="modal-close-btn" id="previewModalCloseBtn">×</button>
            </div>
            <div class="modal-body">
                <div id="preview-questions-container">
                    <!-- Preview questions will be rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="closePreviewBtn" class="btn btn-primary">Close Preview</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const ctx = document.getElementById('accuracyChart')?.getContext('2d');
            if (ctx) {
                const chartCanvas = document.getElementById('accuracyChart');
                const gradient = ctx.createLinearGradient(0, 0, 0, chartCanvas.height * 0.8);
                gradient.addColorStop(0, 'rgba(93, 95, 239, 0.4)');
                gradient.addColorStop(1, 'rgba(93, 95, 239, 0.05)');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                        datasets: [{
                            label: 'Accuracy Trend (%)',
                            data: [65, 59, 80, 81, 56, 55, 78],
                            borderColor: '#5D5FEF',
                            backgroundColor: gradient,
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#5D5FEF',
                            pointBorderColor: '#ffffff',
                            pointHoverBackgroundColor: '#ffffff',
                            pointHoverBorderColor: '#5D5FEF',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            borderWidth: 2.5,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100, grid: { color: '#e9edf5', drawBorder: false }, ticks: { color: '#6c757d', padding: 10 } },
                            x: { grid: { display: false }, ticks: { color: '#6c757d', padding: 10 } }
                        },
                        plugins: {
                            legend: { display: true, position: 'top', align: 'end', labels: { boxWidth: 12, boxHeight: 12, padding: 20, color: '#34495e', font: { weight: '500' } } },
                            tooltip: { backgroundColor: 'rgba(44, 62, 80, 0.85)', titleFont: { size: 14, weight: '600' }, bodyFont: { size: 12 }, padding: 12, cornerRadius: 6, displayColors: false, borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, yAlign: 'bottom' }
                        },
                        hover: { mode: 'index', intersect: false }
                    }
                });
            } else { console.error("Could not find canvas context for accuracyChart"); }

            // --- Create Test Modal Logic ---
            const createTestBtnTrigger = document.getElementById('createTestBtnTrigger');
            const createTestModalOverlay = document.getElementById('createTestModalOverlay');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            const createTestForm = document.getElementById('createTestForm');

            // Test Details Elements
            const testNameInput = document.getElementById('testName');
            const testDescriptionInput = document.getElementById('testDescription');
            const testStartTimeInput = document.getElementById('testStartTime');
            const testEndTimeInput = document.getElementById('testEndTime');
            const testTimeLimitValueInput = document.getElementById('testTimeLimitValue');
            const testTimeLimitUnitSelect = document.getElementById('testTimeLimitUnit');
            const testExpiryDateInput = document.getElementById('testExpiryDate');
            const keywordInput = document.getElementById('keywordInput');
            const keywordsDisplay = document.getElementById('keywordsDisplay');

            // Questions List & Editor Elements
            const questionsListContainer = document.getElementById('questions-list');
            const noQuestionsMsg = document.getElementById('no-questions-msg');
            const questionsCountSpan = document.getElementById('questions-count');
            const questionEditor = document.getElementById('question-editor');
            const editingQuestionNumberSpan = document.getElementById('editingQuestionNumber');
            const questionTextInput = document.getElementById('questionText');
            const optionsContainer = document.getElementById('options-container');
            const addOptionBtn = document.getElementById('addOptionBtn');
            const saveQuestionBtn = document.getElementById('saveQuestionBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');

            // Footer Action Buttons
            const addQuestionBtn = document.getElementById('addQuestionBtn');
            const previewTestBtn = document.getElementById('previewTestBtn');
            const publishTestBtn = document.getElementById('publishTestBtn');

            // Share Link Elements
            const shareLinkSection = document.getElementById('share-link-section');
            const shareLinkInput = document.getElementById('shareLinkInput');
            const copyLinkBtn = document.getElementById('copyLinkBtn');

            // Preview Modal Elements
            const testPreviewModalOverlay = document.getElementById('testPreviewModalOverlay');
            const previewModalCloseBtn = document.getElementById('previewModalCloseBtn');
            const closePreviewBtn = document.getElementById('closePreviewBtn');
            const previewQuestionsContainer = document.getElementById('preview-questions-container');
            const previewModalTitle = document.getElementById('previewModalTitle');


            let keywords = ["Quiz", "Test"];
            let createdQuestions = []; 
            let currentEditingQuestionId = null;
            let nextQuestionId = 1; 
            // --- Helper Functions ---

            const generateUniqueId = () => `q_${nextQuestionId++}`;

            const updateKeywordsDisplay = () => {
                keywordsDisplay.innerHTML = '';
                keywords.forEach(keyword => {
                    const tag = document.createElement('span');
                    tag.classList.add('keyword-tag');
                    tag.textContent = keyword;
                    const removeBtn = document.createElement('button');
                    removeBtn.classList.add('remove-keyword');
                    removeBtn.innerHTML = '×';
                    removeBtn.type = 'button';
                    removeBtn.onclick = () => removeKeyword(keyword);
                    tag.appendChild(removeBtn);
                    keywordsDisplay.appendChild(tag);
                });
            };

            const addKeyword = (keyword) => {
                const trimmedKeyword = keyword.trim();
                if (trimmedKeyword && !keywords.includes(trimmedKeyword)) {
                    keywords.push(trimmedKeyword);
                    updateKeywordsDisplay();
                }
                keywordInput.value = '';
            };

            const removeKeyword = (keywordToRemove) => {
                keywords = keywords.filter(keyword => keyword !== keywordToRemove);
                updateKeywordsDisplay();
            };

            const addOptionToEditor = (text = '', isCorrect = false) => {
                const optionItem = document.createElement('div');
                optionItem.classList.add('option-item');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = isCorrect;
                checkbox.addEventListener('change', validateQuestionEditor);
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = `Option ${optionsContainer.children.length + 1}`;
                input.value = text;
                input.required = true;
                input.addEventListener('input', validateQuestionEditor);
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.classList.add('remove-option-btn', 'btn-icon');
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.title = "Remove Option";
                removeBtn.onclick = () => {
                    optionItem.remove();
                    validateQuestionEditor();
                    updateOptionPlaceholders();
                };

                optionItem.appendChild(checkbox);
                optionItem.appendChild(input);
                optionItem.appendChild(removeBtn);
                optionsContainer.appendChild(optionItem);
                updateOptionPlaceholders();
            };

            const updateOptionPlaceholders = () => {
                const optionInputs = optionsContainer.querySelectorAll('.option-item input[type="text"]');
                optionInputs.forEach((input, index) => input.placeholder = `Option ${index + 1}`);
            };

            const clearQuestionEditor = () => {
                questionTextInput.value = '';
                optionsContainer.innerHTML = '';
                addOptionToEditor(); 
                addOptionToEditor();
                validateQuestionEditor();
            };

            const showQuestionEditor = (questionData = null) => {
                currentEditingQuestionId = questionData ? questionData.id : null;
                questionEditor.style.display = 'block';
                questionEditor.classList.toggle('editing', !!questionData);
                questionTextInput.value = questionData ? questionData.text : '';
                optionsContainer.innerHTML = '';

                if (questionData && questionData.options) {
                    questionData.options.forEach(opt => addOptionToEditor(opt.text, opt.isCorrect));
                    editingQuestionNumberSpan.textContent = createdQuestions.findIndex(q => q.id === questionData.id) + 1;
                } else {
                    editingQuestionNumberSpan.textContent = createdQuestions.length + 1;
                    addOptionToEditor();
                    addOptionToEditor();
                }
                validateQuestionEditor();
                questionEditor.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            };

            const hideQuestionEditor = () => {
                questionEditor.style.display = 'none';
                currentEditingQuestionId = null;
                clearQuestionEditor();
            };

            const validateQuestionEditor = () => {
                const questionText = questionTextInput.value.trim();
                const options = optionsContainer.querySelectorAll('.option-item');
                let optionTextFilledCount = 0;
                let correctAnswerSelected = false;

                if (options.length >= 2) {
                    options.forEach(item => {
                        if (item.querySelector('input[type="text"]').value.trim() !== '') {
                            optionTextFilledCount++;
                        }
                        if (item.querySelector('input[type="checkbox"]').checked) {
                            correctAnswerSelected = true;
                        }
                    });
                }

                const isValid = questionText !== '' && options.length >= 2 && optionTextFilledCount >= 2 && correctAnswerSelected;
                saveQuestionBtn.disabled = !isValid;
                return isValid;
            };

            const renderQuestionCard = (question) => {
                const card = document.createElement('div');
                card.classList.add('question-card');
                card.dataset.questionId = question.id;
                const content = document.createElement('div');
                content.classList.add('question-card-content');
                const qIndex = createdQuestions.findIndex(q => q.id === question.id) + 1;
                content.textContent = `${qIndex}. ${question.text || 'Untitled Question'}`;
                const actions = document.createElement('div');
                actions.classList.add('question-card-actions');
                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.classList.add('btn-icon', 'edit-q-btn');
                editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                editBtn.title = "Edit Question";
                editBtn.onclick = () => showQuestionEditor(question);
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.classList.add('btn-icon', 'delete-q-btn');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.title = "Delete Question";
                deleteBtn.onclick = () => deleteQuestion(question.id);
                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
                card.appendChild(content);
                card.appendChild(actions);
                return card;
            };

            const renderQuestionsList = () => {
                questionsListContainer.innerHTML = '';
                if (createdQuestions.length > 0) {
                    noQuestionsMsg.style.display = 'none';
                    createdQuestions.forEach(q => {
                        questionsListContainer.appendChild(renderQuestionCard(q));
                    });
                } else {
                    noQuestionsMsg.style.display = 'block';
                }
                questionsCountSpan.textContent = createdQuestions.length;
                validateOverallForm();
            };

            const saveQuestion = () => {
                if (!validateQuestionEditor()) return;
                const questionData = {
                    id: currentEditingQuestionId || generateUniqueId(),
                    text: questionTextInput.value.trim(),
                    options: [],
                };
                optionsContainer.querySelectorAll('.option-item').forEach(item => {
                    const text = item.querySelector('input[type="text"]').value.trim();
                    const isCorrect = item.querySelector('input[type="checkbox"]').checked;
                    if (text) {
                        questionData.options.push({ text, isCorrect });
                    }
                });
                if (questionData.options.length < 2 || !questionData.options.some(opt => opt.isCorrect)) {
                    alert("Please ensure at least two options have text and one is marked as correct.");
                    return;
                }
                if (currentEditingQuestionId) {
                    const index = createdQuestions.findIndex(q => q.id === currentEditingQuestionId);
                    if (index !== -1) createdQuestions[index] = questionData;
                } else {
                    createdQuestions.push(questionData);
                }
                renderQuestionsList();
                hideQuestionEditor();
            };

            const deleteQuestion = (questionId) => {
                if (confirm("Are you sure you want to delete this question?")) {
                    createdQuestions = createdQuestions.filter(q => q.id !== questionId);
                    if (currentEditingQuestionId === questionId) hideQuestionEditor();
                    renderQuestionsList();
                }
            };

            const validateOverallForm = () => {
                const testNameValid = testNameInput.value.trim() !== '';
                const questionsExist = createdQuestions.length > 0;
                const isValid = testNameValid && questionsExist;
                publishTestBtn.disabled = !isValid;
                previewTestBtn.disabled = !questionsExist;
                return isValid;
            };

            const resetModal = () => {
                createTestForm.reset(); // Resets basic form fields including name, desc, times, etc.
                // Manually reset datetime-local inputs and time limit group
                testStartTimeInput.value = '';
                testEndTimeInput.value = '';
                testExpiryDateInput.value = '';
                testTimeLimitValueInput.value = ''; // Clear time value
                testTimeLimitUnitSelect.value = 'minutes'; // Reset unit to default

                keywords = ["Quiz", "Test"];
                updateKeywordsDisplay();
                keywordInput.value = '';
                createdQuestions = [];
                nextQuestionId = 1;
                renderQuestionsList();
                hideQuestionEditor();
                shareLinkSection.style.display = 'none';
                // Ensure main sections are visible again
                document.getElementById('test-details-section').style.display = 'block';
                document.getElementById('questions-section').style.display = 'block';
                document.querySelector('#createTestModal .modal-footer').style.display = 'flex';
                validateOverallForm();
            };


            const showPreviewModal = () => {
                previewModalTitle.textContent = testNameInput.value.trim() || "Test Preview";
                previewQuestionsContainer.innerHTML = '';
                if (createdQuestions.length === 0) {
                    previewQuestionsContainer.innerHTML = '<p>No questions added yet.</p>';
                } else {
                    createdQuestions.forEach((q, index) => {
                        const item = document.createElement('div');
                        item.classList.add('preview-question-item');
                        const text = document.createElement('div');
                        text.classList.add('preview-question-text');
                        text.textContent = `${index + 1}. ${q.text}`;
                        item.appendChild(text);
                        const optionsList = document.createElement('ul');
                        optionsList.classList.add('preview-options-list');
                        const correctAnswersCount = q.options.filter(opt => opt.isCorrect).length;
                        const inputType = correctAnswersCount > 1 ? 'checkbox' : 'radio';
                        q.options.forEach((opt, optIndex) => {
                            const li = document.createElement('li');
                            li.classList.add('preview-option');
                            const label = document.createElement('label');
                            const input = document.createElement('input');
                            input.type = inputType;
                            input.name = `preview_q_${q.id}`;
                            input.id = `preview_q_${q.id}_opt_${optIndex}`;
                            // input.disabled = true; // Keep interactive for feel
                            label.htmlFor = input.id;
                            label.appendChild(input);
                            label.appendChild(document.createTextNode(` ${opt.text}`));
                            li.appendChild(label);
                            optionsList.appendChild(li);
                        });
                        item.appendChild(optionsList);
                        previewQuestionsContainer.appendChild(item);
                    });
                }
                testPreviewModalOverlay.classList.add('active');
            };
            const closePreviewModal = () => testPreviewModalOverlay.classList.remove('active');

            const publishTest = () => {
                if (!validateOverallForm()) return;

                // --- Calculate Time Limit in Minutes ---
                let timeLimitInMinutes = null;
                const timeValue = testTimeLimitValueInput.value;
                const timeUnit = testTimeLimitUnitSelect.value;
                if (timeValue) {
                    const numericValue = parseInt(timeValue);
                    if (!isNaN(numericValue) && numericValue > 0) {
                        timeLimitInMinutes = (timeUnit === 'hours') ? numericValue * 60 : numericValue;
                    }
                }
                // --- End Time Limit Calculation ---

                const testData = {
                    name: testNameInput.value.trim(),
                    description: testDescriptionInput.value.trim(),
                    visibility: document.querySelector('input[name="visibility"]:checked').value, // Value is still 'public' or 'unlisted'
                    startTime: testStartTimeInput.value || null,
                    endTime: testEndTimeInput.value || null,
                    timeLimitMinutes: timeLimitInMinutes, // Send consistently in minutes
                    expiryDate: testExpiryDateInput.value || null,
                    keywords: keywords,
                    questions: createdQuestions,
                };

                console.log("Publishing Test Data:", testData);
                // --- SIMULATE API CALL ---
                const fakeShareLink = `https://mindmile.app/test/${Date.now().toString(36)}`; // Example link
                console.log("Simulating API call to save test...");
                // --- END SIMULATION ---

                shareLinkInput.value = fakeShareLink;
                shareLinkSection.style.display = 'block';
                document.getElementById('test-details-section').style.display = 'none';
                document.getElementById('questions-section').style.display = 'none';
                hideQuestionEditor();
                document.querySelector('#createTestModal .modal-footer').style.display = 'none';
                shareLinkSection.scrollIntoView({ behavior: 'smooth' });
            };


            // --- Event Listeners ---
            createTestBtnTrigger?.addEventListener('click', () => {
                resetModal();
                createTestModalOverlay.classList.add('active');
            });
            modalCloseBtn?.addEventListener('click', () => createTestModalOverlay.classList.remove('active'));
            createTestModalOverlay?.addEventListener('click', (event) => {
                if (event.target === createTestModalOverlay) createTestModalOverlay.classList.remove('active');
            });
            window.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    if (createTestModalOverlay.classList.contains('active')) createTestModalOverlay.classList.remove('active');
                    if (testPreviewModalOverlay.classList.contains('active')) closePreviewModal();
                }
            });

            // Keyword Input
            keywordInput?.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ',') { event.preventDefault(); addKeyword(keywordInput.value); }
            });
            keywordInput?.addEventListener('blur', () => addKeyword(keywordInput.value));

            // Test Detail Input Validation
            testNameInput?.addEventListener('input', validateOverallForm);

            // Question Editor Buttons
            addOptionBtn?.addEventListener('click', () => addOptionToEditor());
            saveQuestionBtn?.addEventListener('click', saveQuestion);
            cancelEditBtn?.addEventListener('click', hideQuestionEditor);

            // Footer Buttons
            addQuestionBtn?.addEventListener('click', () => showQuestionEditor());
            previewTestBtn?.addEventListener('click', showPreviewModal);
            publishTestBtn?.addEventListener('click', publishTest);

            // Share Link Button
            copyLinkBtn?.addEventListener('click', () => {
                shareLinkInput.select();
                shareLinkInput.setSelectionRange(0, 99999);
                try {
                    document.execCommand('copy');
                    copyLinkBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    setTimeout(() => { copyLinkBtn.innerHTML = '<i class="fas fa-copy"></i> Copy'; }, 1500);
                } catch (err) { console.error('Failed to copy link: ', err); }
                window.getSelection().removeAllRanges();
            });

            // Preview Modal Close Buttons
            previewModalCloseBtn?.addEventListener('click', closePreviewModal);
            closePreviewBtn?.addEventListener('click', closePreviewModal);
            testPreviewModalOverlay?.addEventListener('click', (event) => {
                if (event.target === testPreviewModalOverlay) closePreviewModal();
            });

            // Initial Setup
            updateKeywordsDisplay();
            renderQuestionsList();
            validateOverallForm();
        });
    </script>

</body>

</html>